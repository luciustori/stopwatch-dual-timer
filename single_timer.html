<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swimming Race Timer - Professional Multi-Heat System</title>
    
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: clamp(28px, 5vw, 48px);
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        /* Event Setup Section */
        .event-setup {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .event-setup.hidden {
            display: none;
        }

        .event-setup h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #FFD700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: bold;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
        }

        /* Heat Progress Section */
        .heat-progress {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .heat-progress h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #FFD700;
        }

        .event-info-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #FFD700;
            margin-bottom: 20px;
        }

        .event-info-card h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #FFD700;
        }

        .event-info-card p {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .heat-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .heat-tab {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .heat-tab.active {
            background: #4ade80;
            color: #1f2937;
            border-color: #22c55e;
        }

        .heat-tab.completed {
            background: rgba(74, 222, 128, 0.3);
            border-color: #4ade80;
        }

        .heat-tab.completed::after {
            content: ' ‚úì';
        }

        .heat-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .status-box {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .status-box.timer {
            font-size: 36px;
            color: #FFD700;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-start {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            color: white;
        }

        .btn-auto {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
        }

        .btn-print {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Lanes Grid */
        .lanes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .lane-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .lane-card.finished {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.2);
            animation: finishPulse 0.6s ease-in-out;
        }

        @keyframes finishPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .lane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .lane-number {
            font-size: 24px;
            font-weight: bold;
        }

        .lane-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .lane-status.waiting {
            background: rgba(255, 255, 255, 0.3);
        }

        .lane-status.racing {
            background: #fbbf24;
            color: #1f2937;
        }

        .lane-status.finished {
            background: #4ade80;
            color: #1f2937;
        }

        .lane-time {
            font-size: 32px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
        }

        .lane-rank {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .swimmer-input {
            margin-top: 10px;
        }

        .swimmer-input input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .manual-finish button {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .manual-finish button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }

        .manual-finish button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Results Modal */
        .results-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .results-modal.show {
            display: block;
        }

        .results-content {
            background: white;
            color: #1f2937;
            padding: 40px;
            border-radius: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .result-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }

        .result-header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .result-event-info {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .result-event-info h2 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .result-event-info p {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .heat-results-section {
            margin-bottom: 40px;
        }

        .heat-results-section h3 {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .result-table th,
        .result-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .result-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .result-table tr:hover {
            background: #f9fafb;
        }

        .result-table .rank-1 {
            background: #fef3c7;
        }

        .result-table .rank-2 {
            background: #e5e7eb;
        }

        .result-table .rank-3 {
            background: #fed7aa;
        }

        .final-ranking {
            background: #fef3c7;
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #fbbf24;
        }

        .final-ranking h2 {
            color: #f59e0b;
            font-size: 28px;
            margin-bottom: 20px;
            text-align: center;
        }

        .qr-section {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin-top: 30px;
            padding: 20px;
            background: #f3f4f6;
            border-radius: 10px;
        }

        .qr-section h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        #qrcode {
            margin-bottom: 10px;
        }

        .qr-section p {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
        }

        .result-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .print-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        @media print {
            body {
                background: white;
                color: black;
                padding: 0;
            }

            .no-print {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .results-content {
                padding: 20px;
            }

            .result-table {
                font-size: 14px;
            }

            .result-table th,
            .result-table td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container no-print">
        <div class="header">
            <h1>üèä Swimming Race Timer Professional</h1>
            <p>Multi-Heat Competition Management System</p>
        </div>

        <!-- Event Setup (Initial) -->
        <div class="event-setup" id="eventSetupForm">
            <h2>üìã Setup Acara & Jumlah Seri</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nama Acara</label>
                    <input type="text" id="eventName" placeholder="Contoh: Kejuaraan Renang Regional">
                </div>
                <div class="form-group">
                    <label>Nomor Acara</label>
                    <input type="text" id="eventNumber" placeholder="Contoh: A-001">
                </div>
                <div class="form-group">
                    <label>Jumlah Seri</label>
                    <input type="number" id="totalHeats" placeholder="Berapa seri?" min="1" max="20" value="3">
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="eventCategory">
                        <option value="Putri">Putri</option>
                        <option value="Putra">Putra</option>
                        <option value="Campuran">Campuran</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Jarak (meter)</label>
                    <select id="eventDistance">
                        <option value="50">50 M</option>
                        <option value="100">100 M</option>
                        <option value="200">200 M</option>
                        <option value="400">400 M</option>
                        <option value="800">800 M</option>
                        <option value="1500">1500 M</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Gaya Renang</label>
                    <select id="eventStyle">
                        <option value="Gaya Bebas">Gaya Bebas</option>
                        <option value="Gaya Punggung">Gaya Punggung</option>
                        <option value="Gaya Dada">Gaya Dada</option>
                        <option value="Gaya Kupu-kupu">Gaya Kupu-kupu</option>
                        <option value="Gaya Ganti">Gaya Ganti</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-success" onclick="setupEvent()" style="width: 100%;">
                BUAT ACARA & GENERATE SERI
            </button>
        </div>

        <!-- Heat Progress (After setup) -->
        <div class="heat-progress" id="heatProgress" style="display: none;">
            <h2>üìä Progress Acara</h2>
            <div class="event-info-card">
                <h3 id="displayEventName">-</h3>
                <p><strong>Kode Acara:</strong> <span id="displayEventCode">-</span></p>
                <p><strong>Total Seri:</strong> <span id="displayTotalHeats">-</span></p>
                <p><strong>Seri Selesai:</strong> <span id="displayCompletedHeats">0</span></p>
            </div>

            <div class="heat-tabs" id="heatTabs">
                <!-- Heat tabs will be generated here -->
            </div>

            <button class="btn btn-success" onclick="viewAllResults()" id="viewAllBtn" disabled>
                üìä LIHAT HASIL KESELURUHAN & RANKING FINAL
            </button>
            <button class="btn btn-reset" onclick="resetEvent()" style="margin-left: 10px;">
                üîÑ RESET ACARA BARU
            </button>
        </div>

        <div class="status-bar">
            <div class="status-box timer" id="currentTime">00:00.00</div>
            <div class="status-box">
                Finished: <span id="finishedCount">0</span>/10
            </div>
            <div class="status-box" id="raceStatus">Ready</div>
        </div>

        <div class="controls">
            <button class="btn btn-start" id="startBtn" onclick="startRace()" disabled>START SERI</button>
            <button class="btn btn-auto" id="autoBtn" onclick="autoSimulation()" disabled>AUTO SIMULATION</button>
            <button class="btn btn-success" onclick="randomizeAllNames()" id="randomNamesBtn" disabled>üé≤ RANDOM NAMA</button>
            <button class="btn btn-reset" onclick="resetCurrentHeat()">RESET SERI INI</button>
            <button class="btn btn-print" id="printHeatBtn" onclick="showHeatResult()" disabled>LIHAT HASIL SERI</button>
        </div>

        <div class="lanes-grid" id="lanesGrid"></div>
    </div>

    <!-- Results Modal -->
    <div class="results-modal" id="resultsModal">
        <div class="results-content" id="printableArea">
            <div id="resultContent">
                <!-- Results will be inserted here -->
            </div>

            <div class="print-buttons no-print">
                <button class="btn btn-print" onclick="printResult()">üñ®Ô∏è PRINT HASIL</button>
                <button class="btn btn-reset" onclick="closeResults()">TUTUP</button>
            </div>
        </div>
    </div>

    <script>
        // Database nama atlet dummy
        const athleteNames = {
            male: [
                "Andi Wijaya", "Budi Santoso", "Chandra Kusuma", "Dedi Prasetyo", "Eko Saputra",
                "Fajar Ramadhan", "Gani Permana", "Hadi Nugroho", "Irfan Hakim", "Joko Susilo",
                "Kevin Tan", "Lukman Hidayat", "Muhammad Rizki", "Nanda Pratama", "Oscar Wijaya",
                "Putra Mahendra", "Reza Firmansyah", "Satria Wibowo", "Taufik Rahman", "Umar Faruq",
                "Victor Setiawan", "Wahyu Kurniawan", "Xavier Gunawan", "Yusuf Adi", "Zaki Firmansyah",
                "Agung Prasetyo", "Bayu Sanjaya", "Cahyo Nugroho", "Dimas Pratama", "Erlangga Putra",
                "Fahmi Hidayat", "Gilang Ramadhan", "Hendra Wijaya", "Indra Gunawan", "Jefri Tan",
                "Khalid Rahman", "Leo Fernandes", "Mario Kusuma", "Naufal Rizky", "Owen Setiawan"
            ],
            female: [
                "Ayu Lestari", "Bella Safitri", "Citra Dewi", "Dina Permata", "Eka Putri",
                "Fitri Handayani", "Gita Savitri", "Hani Rahmawati", "Indah Kusuma", "Jasmine Tan",
                "Kartika Sari", "Linda Wijaya", "Maya Anggraini", "Novi Susanti", "Olivia Chen",
                "Putri Maharani", "Rania Azzahra", "Sari Mulyani", "Tina Rahayu", "Ulfa Hasanah",
                "Vina Angelia", "Wulan Sari", "Xenia Putri", "Yuni Pratiwi", "Zahra Amalia",
                "Anisa Rahma", "Bunga Pertiwi", "Clara Natasha", "Devi Anjani", "Elsa Paramita",
                "Fiona Salsabila", "Grace Permata", "Hanna Rizki", "Intan Cahaya", "Julia Kusuma",
                "Kirana Dewi", "Lusi Anggraini", "Mira Safitri", "Nina Rahma", "Olla Ramadhan"
            ]
        };

        // Event data structure
        let eventData = {
            name: '',
            number: '',
            category: '',
            distance: '',
            style: '',
            totalHeats: 0,
            heats: [],
            setupComplete: false
        };

        // Current heat state
        let currentHeatIndex = 0;
        let raceStarted = false;
        let raceFinished = false;
        let startTime = 0;
        let timerInterval = null;
        let finishedCount = 0;

        // Current heat lanes
        let lanes = [];
        for (let i = 0; i < 10; i++) {
            lanes.push({
                number: i + 1,
                swimmer: '',
                finished: false,
                finishTime: 0,
                rank: 0
            });
        }

        // Get unique random names for all lanes
        function generateUniqueLaneNames() {
            const category = eventData.category;
            let names = [];
            
            if (category === 'Putra') {
                names = [...athleteNames.male];
            } else if (category === 'Putri') {
                names = [...athleteNames.female];
            } else {
                names = [...athleteNames.male, ...athleteNames.female];
            }
            
            shuffleArray(names);
            return names.slice(0, 10);
        }

        function randomizeAllNames() {
            if (!eventData.setupComplete) {
                alert('Setup acara terlebih dahulu!');
                return;
            }
            
            const uniqueNames = generateUniqueLaneNames();
            for (let i = 1; i <= 10; i++) {
                document.getElementById('swimmerName' + i).value = uniqueNames[i - 1];
            }
        }

        // Setup Event
        function setupEvent() {
            const eventName = document.getElementById('eventName').value.trim();
            const eventNumber = document.getElementById('eventNumber').value.trim();
            const totalHeats = parseInt(document.getElementById('totalHeats').value);
            const category = document.getElementById('eventCategory').value;
            const distance = document.getElementById('eventDistance').value;
            const style = document.getElementById('eventStyle').value;

            if (!eventName || !eventNumber || !totalHeats) {
                alert('Mohon lengkapi data acara!');
                return;
            }

            eventData = {
                name: eventName,
                number: eventNumber,
                category: category,
                distance: distance,
                style: style,
                totalHeats: totalHeats,
                heats: [],
                setupComplete: true
            };

            for (let i = 0; i < totalHeats; i++) {
                eventData.heats.push({
                    heatNumber: i + 1,
                    completed: false,
                    timestamp: '',
                    lanes: []
                });
            }

            document.getElementById('eventSetupForm').classList.add('hidden');
            document.getElementById('heatProgress').style.display = 'block';

            updateEventDisplay();
            generateHeatTabs();
            selectHeat(0);
        }

        function updateEventDisplay() {
            const fullName = `${eventData.distance}M ${eventData.style} ${eventData.category}`;
            document.getElementById('displayEventName').textContent = fullName;
            document.getElementById('displayEventCode').textContent = eventData.number;
            document.getElementById('displayTotalHeats').textContent = eventData.totalHeats;
            
            const completedHeats = eventData.heats.filter(h => h.completed).length;
            document.getElementById('displayCompletedHeats').textContent = completedHeats;

            if (completedHeats === eventData.totalHeats) {
                document.getElementById('viewAllBtn').disabled = false;
            }
        }

        function generateHeatTabs() {
            const container = document.getElementById('heatTabs');
            container.innerHTML = '';

            for (let i = 0; i < eventData.totalHeats; i++) {
                const tab = document.createElement('div');
                tab.className = 'heat-tab';
                tab.textContent = `Seri ${i + 1}`;
                tab.onclick = () => selectHeat(i);
                
                if (eventData.heats[i].completed) {
                    tab.classList.add('completed');
                }
                
                container.appendChild(tab);
            }
        }

        function selectHeat(index) {
            if (!eventData.setupComplete) return;

            currentHeatIndex = index;
            
            const tabs = document.querySelectorAll('.heat-tab');
            tabs.forEach((tab, i) => {
                tab.classList.remove('active');
                if (i === index) {
                    tab.classList.add('active');
                }
            });

            if (!eventData.heats[index].completed) {
                resetCurrentHeat();
                document.getElementById('startBtn').disabled = false;
                document.getElementById('autoBtn').disabled = false;
                document.getElementById('randomNamesBtn').disabled = false;
            } else {
                loadHeatData(index);
                document.getElementById('startBtn').disabled = true;
                document.getElementById('autoBtn').disabled = true;
                document.getElementById('randomNamesBtn').disabled = true;
            }
        }

        function loadHeatData(index) {
            const heat = eventData.heats[index];
            lanes = JSON.parse(JSON.stringify(heat.lanes));
            
            for (let i = 1; i <= 10; i++) {
                const lane = lanes[i - 1];
                const laneCard = document.getElementById('lane' + i);
                
                if (lane.finished) {
                    laneCard.classList.add('finished');
                    
                    const minutes = Math.floor(lane.finishTime / 60000);
                    const seconds = Math.floor((lane.finishTime % 60000) / 1000);
                    const centiseconds = Math.floor((lane.finishTime % 1000) / 10);
                    const timeStr = String(minutes).padStart(2, '0') + ':' +
                                   String(seconds).padStart(2, '0') + '.' + 
                                   String(centiseconds).padStart(2, '0');
                    
                    laneCard.querySelector('.lane-time').textContent = timeStr;
                    laneCard.querySelector('.lane-status').textContent = 'FINISHED';
                    laneCard.querySelector('.lane-status').className = 'lane-status finished';
                    
                    let rankText = 'Rank #' + lane.rank;
                    if (lane.rank === 1) rankText = 'ü•á ' + rankText;
                    else if (lane.rank === 2) rankText = 'ü•à ' + rankText;
                    else if (lane.rank === 3) rankText = 'ü•â ' + rankText;
                    
                    laneCard.querySelector('.lane-rank').textContent = rankText;
                    document.getElementById('swimmerName' + i).value = lane.swimmer;
                    document.getElementById('swimmerName' + i).disabled = true;
                }
            }

            document.getElementById('printHeatBtn').disabled = false;
        }

        function initLanes() {
            const grid = document.getElementById('lanesGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 10; i++) {
                const laneCard = document.createElement('div');
                laneCard.className = 'lane-card';
                laneCard.id = 'lane' + i;
                laneCard.innerHTML = `
                    <div class="lane-header">
                        <div class="lane-number">Lane ${i}</div>
                        <div class="lane-status waiting">Waiting</div>
                    </div>
                    <div class="swimmer-input">
                        <input type="text" id="swimmerName${i}" placeholder="Nama Atlet">
                    </div>
                    <div class="lane-time">--:--.--</div>
                    <div class="lane-rank"></div>
                    <div class="manual-finish">
                        <button onclick="finishLane(${i})" id="finishBtn${i}" disabled>
                            FINISH LANE ${i}
                        </button>
                    </div>
                `;
                grid.appendChild(laneCard);
            }
        }

        function startRace() {
            if (raceStarted) return;
            if (eventData.heats[currentHeatIndex].completed) {
                alert('Seri ini sudah selesai!');
                return;
            }

            let countdown = 3;
            document.getElementById('raceStatus').textContent = 'Starting...';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('autoBtn').disabled = true;
            document.getElementById('randomNamesBtn').disabled = true;

            const countdownInterval = setInterval(() => {
                document.getElementById('currentTime').textContent = countdown.toString();
                playBeep();
                countdown--;

                if (countdown < 0) {
                    clearInterval(countdownInterval);
                    
                    raceStarted = true;
                    raceFinished = false;
                    startTime = Date.now();
                    finishedCount = 0;
                    
                    document.getElementById('raceStatus').textContent = `Seri ${currentHeatIndex + 1} Racing...`;
                    document.getElementById('currentTime').textContent = '00:00.00';
                    playBeep(true);
                    
                    for (let i = 1; i <= 10; i++) {
                        document.getElementById('finishBtn' + i).disabled = false;
                        document.getElementById('swimmerName' + i).disabled = true;
                        updateLaneStatus(i, 'racing');
                    }
                    
                    startTimer();
                }
            }, 1000);
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                const centiseconds = Math.floor((elapsed % 1000) / 10);
                
                document.getElementById('currentTime').textContent = 
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0') + '.' + 
                    String(centiseconds).padStart(2, '0');
            }, 10);
        }

        function finishLane(laneNumber) {
            const lane = lanes[laneNumber - 1];
            if (lane.finished || !raceStarted) return;

            const finishTime = Date.now() - startTime;
            const swimmerName = document.getElementById('swimmerName' + laneNumber).value.trim();
            
            lane.swimmer = swimmerName || `Atlet ${laneNumber}`;
            lane.finished = true;
            lane.finishTime = finishTime;
            finishedCount++;

            let rank = 1;
            for (let i = 0; i < 10; i++) {
                if (i !== laneNumber - 1 && lanes[i].finished && lanes[i].finishTime < finishTime) {
                    rank++;
                }
            }
            lane.rank = rank;

            updateLaneDisplay(laneNumber, finishTime, rank);
            document.getElementById('finishedCount').textContent = finishedCount;
            document.getElementById('finishBtn' + laneNumber).disabled = true;
            
            playBeep();

            if (finishedCount >= 10) {
                finishHeat();
            }
        }

        function updateLaneDisplay(laneNumber, time, rank) {
            const laneCard = document.getElementById('lane' + laneNumber);
            laneCard.classList.add('finished');
            
            const minutes = Math.floor(time / 60000);
            const seconds = Math.floor((time % 60000) / 1000);
            const centiseconds = Math.floor((time % 1000) / 10);
            const timeStr = String(minutes).padStart(2, '0') + ':' +
                           String(seconds).padStart(2, '0') + '.' + 
                           String(centiseconds).padStart(2, '0');
            
            laneCard.querySelector('.lane-time').textContent = timeStr;
            laneCard.querySelector('.lane-status').textContent = 'FINISHED';
            laneCard.querySelector('.lane-status').className = 'lane-status finished';
            
            let rankText = 'Rank #' + rank;
            if (rank === 1) rankText = 'ü•á ' + rankText;
            else if (rank === 2) rankText = 'ü•à ' + rankText;
            else if (rank === 3) rankText = 'ü•â ' + rankText;
            
            laneCard.querySelector('.lane-rank').textContent = rankText;
        }

        function updateLaneStatus(laneNumber, status) {
            const laneCard = document.getElementById('lane' + laneNumber);
            const statusElement = laneCard.querySelector('.lane-status');
            statusElement.textContent = status.toUpperCase();
            statusElement.className = 'lane-status ' + status;
        }

        function finishHeat() {
            raceFinished = true;
            clearInterval(timerInterval);
            document.getElementById('raceStatus').textContent = `Seri ${currentHeatIndex + 1} Selesai!`;
            document.getElementById('printHeatBtn').disabled = false;
            playBeep(true, true);

            eventData.heats[currentHeatIndex] = {
                heatNumber: currentHeatIndex + 1,
                completed: true,
                timestamp: new Date().toLocaleString('id-ID'),
                lanes: JSON.parse(JSON.stringify(lanes))
            };

            updateEventDisplay();
            generateHeatTabs();

            if (currentHeatIndex < eventData.totalHeats - 1) {
                setTimeout(() => {
                    if (confirm(`Seri ${currentHeatIndex + 1} selesai! Lanjut ke Seri ${currentHeatIndex + 2}?`)) {
                        selectHeat(currentHeatIndex + 1);
                    }
                }, 2000);
            } else {
                setTimeout(() => {
                    alert('üéâ Semua seri selesai! Klik "LIHAT HASIL KESELURUHAN" untuk melihat ranking final.');
                }, 2000);
            }
        }

        function showHeatResult() {
            const heat = eventData.heats[currentHeatIndex];
            if (!heat.completed) {
                alert('Seri ini belum selesai!');
                return;
            }

            const sortedLanes = [...heat.lanes].sort((a, b) => a.finishTime - b.finishTime);
            
            let html = `
                <div class="result-header">
                    <h1>üèä HASIL SERI ${heat.heatNumber}</h1>
                    <p>Official Heat Results</p>
                </div>

                <div class="result-event-info">
                    <h2>Informasi Acara</h2>
                    <p><strong>Nama Acara:</strong> ${eventData.name}</p>
                    <p><strong>Kode Acara:</strong> ${eventData.number}</p>
                    <p><strong>Seri:</strong> ${heat.heatNumber} dari ${eventData.totalHeats}</p>
                    <p><strong>Kategori:</strong> ${eventData.category}</p>
                    <p><strong>Jarak:</strong> ${eventData.distance} Meter</p>
                    <p><strong>Gaya:</strong> ${eventData.style}</p>
                    <p><strong>Waktu:</strong> ${heat.timestamp}</p>
                </div>

                <div class="heat-results-section">
                    <h3>Hasil Seri ${heat.heatNumber}</h3>
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Lane</th>
                                <th>Nama Atlet</th>
                                <th>Time</th>
                                <th>Medal</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sortedLanes.forEach((lane, index) => {
                const rank = index + 1;
                const minutes = Math.floor(lane.finishTime / 60000);
                const seconds = Math.floor((lane.finishTime % 60000) / 1000);
                const centiseconds = Math.floor((lane.finishTime % 1000) / 10);
                const timeStr = String(minutes).padStart(2, '0') + ':' +
                               String(seconds).padStart(2, '0') + '.' + 
                               String(centiseconds).padStart(2, '0');

                let medal = '';
                let rowClass = '';
                if (rank === 1) {
                    medal = 'ü•á Gold';
                    rowClass = 'rank-1';
                } else if (rank === 2) {
                    medal = 'ü•à Silver';
                    rowClass = 'rank-2';
                } else if (rank === 3) {
                    medal = 'ü•â Bronze';
                    rowClass = 'rank-3';
                }

                html += `
                    <tr class="${rowClass}">
                        <td><strong>#${rank}</strong></td>
                        <td>Lane ${lane.number}</td>
                        <td>${lane.swimmer}</td>
                        <td><strong>${timeStr}</strong></td>
                        <td>${medal}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <div class="qr-section">
                    <h3>QR Code - Heat ${heat.heatNumber} Data</h3>
                    <div id="qrcode"></div>
                    <p>Scan untuk verifikasi digital data hasil seri</p>
                </div>

                <div class="result-footer">
                    <p><strong>Timestamp:</strong> ${heat.timestamp}</p>
                    <p style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                        Powered by HRISKU Swimming Timer System
                    </p>
                </div>
            `;

            document.getElementById('resultContent').innerHTML = html;
            
            const qrData = {
                event: eventData.name,
                code: eventData.number,
                heat: heat.heatNumber,
                timestamp: heat.timestamp,
                results: sortedLanes.map((lane, index) => ({
                    rank: index + 1,
                    lane: lane.number,
                    swimmer: lane.swimmer,
                    time: lane.finishTime
                }))
            };

            new QRCode(document.getElementById('qrcode'), {
                text: JSON.stringify(qrData),
                width: 200,
                height: 200,
                correctLevel: QRCode.CorrectLevel.H
            });

            document.getElementById('resultsModal').classList.add('show');
        }

        function viewAllResults() {
            const completedHeats = eventData.heats.filter(h => h.completed);
            if (completedHeats.length !== eventData.totalHeats) {
                alert('Belum semua seri selesai!');
                return;
            }

            let allResults = [];
            completedHeats.forEach(heat => {
                heat.lanes.forEach(lane => {
                    allResults.push({
                        heat: heat.heatNumber,
                        lane: lane.number,
                        swimmer: lane.swimmer,
                        time: lane.finishTime
                    });
                });
            });

            allResults.sort((a, b) => a.time - b.time);

            let html = `
                <div class="result-header">
                    <h1>üèÜ HASIL LENGKAP ACARA</h1>
                    <p>Complete Event Results & Final Ranking</p>
                </div>

                <div class="result-event-info">
                    <h2>Informasi Acara</h2>
                    <p><strong>Nama Acara:</strong> ${eventData.name}</p>
                    <p><strong>Kode Acara:</strong> ${eventData.number}</p>
                    <p><strong>Total Seri:</strong> ${eventData.totalHeats} Seri</p>
                    <p><strong>Total Peserta:</strong> ${allResults.length} Atlet</p>
                    <p><strong>Kategori:</strong> ${eventData.category}</p>
                    <p><strong>Jarak:</strong> ${eventData.distance} Meter</p>
                    <p><strong>Gaya:</strong> ${eventData.style}</p>
                </div>
            `;

            completedHeats.forEach(heat => {
                const heatResults = [...heat.lanes].sort((a, b) => a.finishTime - b.finishTime);
                
                html += `
                    <div class="heat-results-section">
                        <h3>Seri ${heat.heatNumber} - ${heat.timestamp}</h3>
                        <table class="result-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Lane</th>
                                    <th>Nama Atlet</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                heatResults.forEach((lane, index) => {
                    const rank = index + 1;
                    const minutes = Math.floor(lane.finishTime / 60000);
                    const seconds = Math.floor((lane.finishTime % 60000) / 1000);
                    const centiseconds = Math.floor((lane.finishTime % 1000) / 10);
                    const timeStr = String(minutes).padStart(2, '0') + ':' +
                                   String(seconds).padStart(2, '0') + '.' + 
                                   String(centiseconds).padStart(2, '0');

                    html += `
                        <tr>
                            <td><strong>#${rank}</strong></td>
                            <td>Lane ${lane.number}</td>
                            <td>${lane.swimmer}</td>
                            <td><strong>${timeStr}</strong></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            html += `
                <div class="final-ranking">
                    <h2>üèÜ RANKING FINAL KESELURUHAN üèÜ</h2>
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Nama Atlet</th>
                                <th>Seri</th>
                                <th>Lane</th>
                                <th>Time</th>
                                <th>Medal</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            allResults.forEach((result, index) => {
                const rank = index + 1;
                const minutes = Math.floor(result.time / 60000);
                const seconds = Math.floor((result.time % 60000) / 1000);
                const centiseconds = Math.floor((result.time % 1000) / 10);
                const timeStr = String(minutes).padStart(2, '0') + ':' +
                               String(seconds).padStart(2, '0') + '.' + 
                               String(centiseconds).padStart(2, '0');

                let medal = '';
                let rowClass = '';
                if (rank === 1) {
                    medal = 'ü•á CHAMPION';
                    rowClass = 'rank-1';
                } else if (rank === 2) {
                    medal = 'ü•à 2nd Place';
                    rowClass = 'rank-2';
                } else if (rank === 3) {
                    medal = 'ü•â 3rd Place';
                    rowClass = 'rank-3';
                }

                html += `
                    <tr class="${rowClass}">
                        <td><strong>#${rank}</strong></td>
                        <td><strong>${result.swimmer}</strong></td>
                        <td>Seri ${result.heat}</td>
                        <td>Lane ${result.lane}</td>
                        <td><strong>${timeStr}</strong></td>
                        <td><strong>${medal}</strong></td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <div class="qr-section">
                    <h3>QR Code - Complete Event Data</h3>
                    <div id="qrcode"></div>
                    <p>Scan untuk verifikasi digital data lengkap acara</p>
                </div>

                <div class="result-footer">
                    <p><strong>Generated:</strong> ${new Date().toLocaleString('id-ID')}</p>
                    <p style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                        Powered by HRISKU Swimming Timer System
                    </p>
                </div>
            `;

            document.getElementById('resultContent').innerHTML = html;

            const qrData = {
                event: eventData.name,
                code: eventData.number,
                totalHeats: eventData.totalHeats,
                category: eventData.category,
                distance: eventData.distance,
                style: eventData.style,
                finalRanking: allResults.slice(0, 10).map((result, index) => ({
                    rank: index + 1,
                    swimmer: result.swimmer,
                    heat: result.heat,
                    lane: result.lane,
                    time: result.time
                }))
            };

            new QRCode(document.getElementById('qrcode'), {
                text: JSON.stringify(qrData),
                width: 200,
                height: 200,
                correctLevel: QRCode.CorrectLevel.H
            });

            document.getElementById('resultsModal').classList.add('show');
        }

        function printResult() {
            window.print();
        }

        function closeResults() {
            document.getElementById('resultsModal').classList.remove('show');
        }

        function resetCurrentHeat() {
            raceStarted = false;
            raceFinished = false;
            startTime = 0;
            finishedCount = 0;
            clearInterval(timerInterval);

            lanes = [];
            for (let i = 0; i < 10; i++) {
                lanes.push({
                    number: i + 1,
                    swimmer: '',
                    finished: false,
                    finishTime: 0,
                    rank: 0
                });
            }

            document.getElementById('currentTime').textContent = '00:00.00';
            document.getElementById('finishedCount').textContent = '0';
            document.getElementById('raceStatus').textContent = 'Ready';
            document.getElementById('printHeatBtn').disabled = true;

            for (let i = 1; i <= 10; i++) {
                const laneCard = document.getElementById('lane' + i);
                laneCard.classList.remove('finished');
                laneCard.querySelector('.lane-time').textContent = '--:--.--';
                laneCard.querySelector('.lane-status').textContent = 'Waiting';
                laneCard.querySelector('.lane-status').className = 'lane-status waiting';
                laneCard.querySelector('.lane-rank').textContent = '';
                document.getElementById('swimmerName' + i).value = '';
                document.getElementById('swimmerName' + i).disabled = false;
                document.getElementById('finishBtn' + i).disabled = true;
            }
        }

        function resetEvent() {
            if (confirm('Reset seluruh acara? Semua data seri akan hilang!')) {
                eventData = {
                    name: '',
                    number: '',
                    category: '',
                    distance: '',
                    style: '',
                    totalHeats: 0,
                    heats: [],
                    setupComplete: false
                };

                currentHeatIndex = 0;
                resetCurrentHeat();

                document.getElementById('eventSetupForm').classList.remove('hidden');
                document.getElementById('heatProgress').style.display = 'none';
                document.getElementById('startBtn').disabled = true;
                document.getElementById('autoBtn').disabled = true;
                document.getElementById('randomNamesBtn').disabled = true;
            }
        }

        function autoSimulation() {
            const uniqueNames = generateUniqueLaneNames();
            for (let i = 1; i <= 10; i++) {
                document.getElementById('swimmerName' + i).value = uniqueNames[i - 1];
            }

            startRace();

            setTimeout(() => {
                const baseTimes = [];
                for (let i = 0; i < 10; i++) {
                    baseTimes.push(25000 + Math.random() * 10000);
                }
                baseTimes.sort((a, b) => a - b);

                const laneOrder = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
                shuffleArray(laneOrder);

                laneOrder.forEach((laneNum, index) => {
                    setTimeout(() => {
                        finishLane(laneNum);
                    }, baseTimes[index]);
                });
            }, 4000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function playBeep(long = false, victory = false) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                if (victory) {
                    oscillator.frequency.value = 1500;
                    gainNode.gain.value = 0.3;
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } else if (long) {
                    oscillator.frequency.value = 2000;
                    gainNode.gain.value = 0.3;
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.8);
                } else {
                    oscillator.frequency.value = 1200;
                    gainNode.gain.value = 0.2;
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.15);
                }
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        window.addEventListener('load', function() {
            initLanes();
        });
    </script>
</body>
</html>
